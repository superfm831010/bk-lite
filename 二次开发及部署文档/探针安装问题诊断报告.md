# 探针安装问题诊断报告

## 诊断时间
2025-10-21

## 问题现象
Linux服务器（192.168.31.10）安装探针后，后台提示"安装成功"，但节点管理界面看不到该服务器。

## 排查过程

### 1. 检查SERVER_URL配置

```sql
SELECT id, cloud_region_id, key, value, type FROM node_mgmt_sidecarenv;
```

**发现**：
- 云区域1(default)有配置：NODE_SERVER_URL = `http://192.168.31.10:8080`
- **云区域2(管理网)没有任何环境变量配置**

### 2. 检查节点注册情况

```sql
SELECT id, name, ip FROM node_mgmt_node;
```

**结果**：0条记录，没有任何节点注册成功。

### 3. 检查安装任务

```sql
SELECT id, type, status, cloud_region_id FROM node_mgmt_controllertask;
```

**发现**：
- 3个安装任务，状态都是 `finished`
- 所有任务都在云区域2(管理网)中执行
- 任务详情显示所有步骤都是 `success`

### 4. 检查目标服务器Sidecar服务状态

```bash
systemctl status sidecar.service
```

**发现**：
- 服务状态：`activating (auto-restart) (Result: exit-code)`
- 退出代码：1 (失败)
- 已重启：524次

### 5. 查看Sidecar日志

```bash
journalctl -u sidecar.service -n 50
```

**关键错误**：
```
level=fatal msg="Server-url is not valid. Should be like http://127.0.0.1:9000/api/ <nil>"
```

### 6. 检查Sidecar配置文件

```bash
cat /opt/fusion-collectors/sidecar.yml
```

**发现问题**：
```yaml
server_url: "null/api/v1/node_mgmt/open_api/node"
```

## 根本原因

### 问题链条

1. **云区域2缺少配置**
   - 用户在云区域2(管理网)中安装探针
   - 云区域2的 `node_mgmt_sidecarenv` 表中没有 `NODE_SERVER_URL` 配置

2. **安装时获取到错误的server_url**
   - 代码位置：`server/apps/node_mgmt/services/installer.py:19-20`
   ```python
   obj = SidecarEnv.objects.filter(cloud_region=cloud_region_id, key=NodeConstants.SERVER_URL_KEY).first()
   server_url = obj.value if obj else "null"  # 没找到配置，返回字符串"null"
   ```

3. **安装脚本将"null"写入配置文件**
   - 安装脚本执行时传入的参数：`server_url="null"`
   - 生成的配置文件：`server_url: "null/api/v1/node_mgmt/open_api/node"`

4. **Sidecar启动失败**
   - Sidecar启动时校验URL格式
   - "null/api/v1/node_mgmt/open_api/node" 不是有效的URL
   - 程序抛出fatal错误并退出（exit code 1）

5. **systemd不断重启**
   - systemd检测到服务异常退出
   - 自动重启服务（已重启524次）
   - 每次重启都因为相同原因失败

6. **节点从未注册**
   - Sidecar服务从未成功运行
   - 从未向Server发送心跳请求
   - Node表中没有创建记录
   - 前端界面看不到节点

## 解决方案

### 方案1：为云区域2配置NODE_SERVER_URL（推荐）

#### 步骤1：添加配置到数据库

```bash
# 确定正确的Server URL（根据实际部署情况选择）
# 如果使用Traefik反向代理，端口通常是 8080
# 如果直接访问Server，端口是 18001

# 方式1：使用Traefik反向代理（端口8080）
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "INSERT INTO node_mgmt_sidecarenv (cloud_region_id, key, value, type, description, is_pre)
   VALUES (2, 'NODE_SERVER_URL', 'http://192.168.31.10:8080', '', 'Server访问地址', true);"

# 方式2：直接访问Server（端口18001）
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "INSERT INTO node_mgmt_sidecarenv (cloud_region_id, key, value, type, description, is_pre)
   VALUES (2, 'NODE_SERVER_URL', 'http://192.168.31.10:18001', '', 'Server访问地址', true);"
```

#### 步骤2：重新安装探针

在前端界面重新安装探针，或者手动修复已安装的探针：

**手动修复方法**：

```bash
# 1. 停止服务
sudo systemctl stop sidecar.service

# 2. 修改配置文件
sudo sed -i 's|server_url: "null/api/v1/node_mgmt/open_api/node"|server_url: "http://192.168.31.10:8080/api/v1/node_mgmt/open_api/node"|' /opt/fusion-collectors/sidecar.yml

# 或者直接使用Server端口18001
sudo sed -i 's|server_url: "null/api/v1/node_mgmt/open_api/node"|server_url: "http://192.168.31.10:18001/api/v1/node_mgmt/open_api/node"|' /opt/fusion-collectors/sidecar.yml

# 3. 重启服务
sudo systemctl restart sidecar.service

# 4. 检查服务状态
sudo systemctl status sidecar.service

# 5. 查看日志确认正常运行
journalctl -u sidecar.service -f
```

### 方案2：完善其他环境变量配置

除了NODE_SERVER_URL，云区域2还缺少其他必要的环境变量：

```bash
# NATS相关配置（从云区域1复制）
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite << 'EOF'
INSERT INTO node_mgmt_sidecarenv (cloud_region_id, key, value, type, description, is_pre)
SELECT 2, key, value, type, description, is_pre
FROM node_mgmt_sidecarenv
WHERE cloud_region_id = 1;
EOF
```

## 验证修复

### 1. 检查配置是否正确

```bash
# 查看云区域2的配置
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT key, value FROM node_mgmt_sidecarenv WHERE cloud_region_id=2;"
```

### 2. 检查Sidecar服务状态

```bash
# 服务应该处于 active (running) 状态
systemctl status sidecar.service

# 日志中应该看到成功连接的信息
journalctl -u sidecar.service -n 20
```

### 3. 检查节点是否注册

等待30-60秒后（Sidecar默认30秒发送一次心跳）：

```bash
# 应该能看到节点记录
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, name, ip, updated_at FROM node_mgmt_node;"
```

### 4. 在前端界面查看

刷新节点管理页面，应该能看到 192.168.31.10 节点。

## 预防措施

### 1. 完善初始化流程

建议在创建云区域时，自动复制必要的环境变量配置：

**数据库脚本位置**：`server/apps/node_mgmt/初始化相关代码`

### 2. 改进错误处理

**代码位置**：`server/apps/node_mgmt/services/installer.py:19-20`

**建议修改**：
```python
obj = SidecarEnv.objects.filter(cloud_region=cloud_region_id, key=NodeConstants.SERVER_URL_KEY).first()
if not obj:
    raise ValueError(f"云区域 {cloud_region_id} 缺少 NODE_SERVER_URL 配置，请先在系统设置中配置")
server_url = obj.value
```

这样可以在安装前就发现配置缺失，避免安装后才发现问题。

### 3. 前端校验

在前端安装探针时，先检查云区域是否有必要的配置，如果缺失则提示用户。

### 4. 文档说明

在系统管理文档中说明：
- 创建新云区域后，必须配置 NODE_SERVER_URL
- NODE_SERVER_URL 应该是目标服务器可访问的地址
- 端口通常是 8080（Traefik）或 18001（直接访问）

## 总结

### 问题分类
- **类型**：配置缺失
- **影响范围**：云区域2(管理网)的所有探针安装
- **严重程度**：高（导致功能完全不可用）

### 关键教训
1. **安装成功 ≠ 运行成功**：安装脚本执行完成，但服务可能无法启动
2. **配置校验的重要性**：应该在安装前校验必要的配置是否存在
3. **错误信息的可见性**：systemd日志中的错误没有反馈到安装任务结果中

### 后续改进建议
1. 在安装任务中增加服务启动状态检查
2. 将Sidecar的启动日志同步到安装任务结果中
3. 在云区域管理界面添加配置完整性检查
4. 创建云区域时自动复制必要的环境变量模板

## 附录

### A. 诊断命令清单

```bash
# 1. 检查云区域配置
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT cloud_region_id, key, value FROM node_mgmt_sidecarenv ORDER BY cloud_region_id;"

# 2. 检查节点注册
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, name, ip, updated_at FROM node_mgmt_node;"

# 3. 检查安装任务
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT t.id, t.status, tn.ip, tn.status FROM node_mgmt_controllertask t
   JOIN node_mgmt_controllertasknode tn ON t.id = tn.task_id ORDER BY t.updated_at DESC LIMIT 10;"

# 4. 检查Sidecar服务
systemctl status sidecar.service
journalctl -u sidecar.service -n 50

# 5. 检查配置文件
cat /opt/fusion-collectors/sidecar.yml
```

### B. 快速修复脚本

保存为 `fix_probe.sh`：

```bash
#!/bin/bash

# 快速修复探针配置脚本
# 用途：修复云区域2的SERVER_URL配置问题

set -e

echo "=== 探针配置修复脚本 ==="
echo

# 1. 添加NODE_SERVER_URL配置
echo "1. 添加NODE_SERVER_URL配置到云区域2..."
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "INSERT INTO node_mgmt_sidecarenv (cloud_region_id, key, value, type, description, is_pre)
   VALUES (2, 'NODE_SERVER_URL', 'http://192.168.31.10:8080', '', 'Server访问地址', true)
   ON CONFLICT (key, cloud_region_id) DO UPDATE SET value = 'http://192.168.31.10:8080';" 2>/dev/null || true

echo "✓ 配置已添加"
echo

# 2. 修复Sidecar配置文件
echo "2. 修复Sidecar配置文件..."
if [ -f /opt/fusion-collectors/sidecar.yml ]; then
    sudo sed -i 's|server_url: "null/api/v1/node_mgmt/open_api/node"|server_url: "http://192.168.31.10:8080/api/v1/node_mgmt/open_api/node"|' /opt/fusion-collectors/sidecar.yml
    echo "✓ 配置文件已修复"
else
    echo "⚠ 未找到配置文件，跳过"
fi
echo

# 3. 重启服务
echo "3. 重启Sidecar服务..."
if systemctl is-active --quiet sidecar.service 2>/dev/null; then
    sudo systemctl restart sidecar.service
    echo "✓ 服务已重启"
else
    echo "⚠ 服务未运行，尝试启动..."
    sudo systemctl start sidecar.service 2>/dev/null || echo "✗ 启动失败，请检查日志"
fi
echo

# 4. 检查状态
echo "4. 检查服务状态..."
sleep 3
sudo systemctl status sidecar.service --no-pager -l || true
echo

# 5. 查看最新日志
echo "5. 最新日志（最后10行）："
journalctl -u sidecar.service -n 10 --no-pager || true
echo

echo "=== 修复完成 ==="
echo "请等待30-60秒后刷新前端页面查看节点是否出现"
```

使用方法：
```bash
chmod +x fix_probe.sh
sudo ./fix_probe.sh
```
