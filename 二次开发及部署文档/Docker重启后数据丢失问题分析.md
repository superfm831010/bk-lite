# Docker é‡å¯åæ¢é’ˆæ•°æ®ä¸¢å¤±é—®é¢˜åˆ†æä¸è§£å†³

## æ–‡æ¡£ä¿¡æ¯

- **é—®é¢˜æ—¥æœŸ**: 2025-10-21
- **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜å±ï¼ˆå¯¼è‡´ç”Ÿäº§æ•°æ®ä¸¢å¤±ï¼‰
- **å½±å“èŒƒå›´**: æ‰‹åŠ¨ä¸Šä¼ çš„æ¢é’ˆåŒ…ã€èŠ‚ç‚¹å®‰è£…è®°å½•
- **ç‰ˆæœ¬**: 1.0.0

---

## ä¸€ã€é—®é¢˜ç°è±¡

### 1.1 é—®é¢˜æè¿°

æ‰§è¡Œ `docker-compose down -v` é‡å¯æœåŠ¡åï¼Œå‘ç°ï¼š

1. âŒ **æ¢é’ˆåŒ…åˆ—è¡¨ä¸ºç©º** - ä¹‹å‰ä¸Šä¼ çš„æ§åˆ¶å™¨åŒ…å’Œé‡‡é›†å™¨åŒ…éƒ½ä¸è§äº†
2. âŒ **å·²å®‰è£…çš„èŠ‚ç‚¹è®°å½•ä¸¢å¤±** - ä¹‹å‰å®‰è£…æ¢é’ˆçš„æœåŠ¡å™¨è®°å½•æ¶ˆå¤±
3. âŒ **å®‰è£…å†å²è®°å½•æ¸…ç©º** - æ‰€æœ‰å®‰è£…ä»»åŠ¡å’Œæ—¥å¿—éƒ½ä¸è§äº†
4. âœ… **ç³»ç»Ÿé¢„ç½®æ•°æ®ä»åœ¨** - é‡‡é›†å™¨å®šä¹‰ã€æ§åˆ¶å™¨å®šä¹‰ç­‰è‡ªåŠ¨åˆå§‹åŒ–çš„æ•°æ®è¿˜åœ¨

### 1.2 æ•°æ®åº“çŠ¶æ€å¯¹æ¯”

#### é‡å¯å‰ï¼ˆé¢„æœŸçŠ¶æ€ï¼‰
```sql
SELECT COUNT(*) FROM node_mgmt_packageversion;
-- é¢„æœŸ: 8 æ¡ï¼ˆ1ä¸ªæ§åˆ¶å™¨ + 7ä¸ªé‡‡é›†å™¨ï¼‰

SELECT COUNT(*) FROM node_mgmt_node;
-- é¢„æœŸ: N æ¡ï¼ˆå·²å®‰è£…æ¢é’ˆçš„èŠ‚ç‚¹ï¼‰

SELECT COUNT(*) FROM node_mgmt_nodecollectorinstallstatus;
-- é¢„æœŸ: M æ¡ï¼ˆé‡‡é›†å™¨å®‰è£…çŠ¶æ€ï¼‰
```

#### é‡å¯åï¼ˆå®é™…çŠ¶æ€ï¼‰
```sql
SELECT COUNT(*) FROM node_mgmt_packageversion;
-- ç»“æœ: 0 æ¡ âŒ

SELECT COUNT(*) FROM node_mgmt_node;
-- ç»“æœ: 0 æ¡ âŒ

SELECT COUNT(*) FROM node_mgmt_nodecollectorinstallstatus;
-- ç»“æœ: 0 æ¡ âŒ

-- ä½†æ˜¯ç³»ç»Ÿé¢„ç½®æ•°æ®è¿˜åœ¨ï¼š
SELECT COUNT(*) FROM node_mgmt_collector;
-- ç»“æœ: 28 æ¡ âœ…ï¼ˆé‡‡é›†å™¨å®šä¹‰ï¼‰

SELECT COUNT(*) FROM node_mgmt_controller;
-- ç»“æœ: 2 æ¡ âœ…ï¼ˆæ§åˆ¶å™¨å®šä¹‰ï¼‰
```

---

## äºŒã€æ ¹æœ¬åŸå› åˆ†æ

### 2.1 å‘½ä»¤å¯¹æ¯”

#### âŒ é”™è¯¯çš„é‡å¯æ–¹å¼
```bash
docker-compose down -v
```

**`-v` å‚æ•°çš„ä½œç”¨**ï¼š
- åˆ é™¤ `docker-compose.yml` ä¸­å®šä¹‰çš„æ‰€æœ‰**å‘½åå·ï¼ˆnamed volumesï¼‰**
- åˆ é™¤å®¹å™¨è‡ªåŠ¨åˆ›å»ºçš„åŒ¿åå·
- **è¿™ä¼šæ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼**

#### âœ… æ­£ç¡®çš„é‡å¯æ–¹å¼

```bash
# æ–¹å¼ 1: åªé‡å¯å®¹å™¨ï¼ˆæœ€å®‰å…¨ï¼‰
docker-compose restart

# æ–¹å¼ 2: åœæ­¢å¹¶é‡æ–°åˆ›å»ºå®¹å™¨ï¼ˆä¿ç•™æ•°æ®å·ï¼‰
docker-compose down
docker-compose up -d

# æ–¹å¼ 3: é‡å¯å•ä¸ªæœåŠ¡
docker-compose restart server
```

### 2.2 æ•°æ®ä¸¢å¤±æœºåˆ¶

å½“æ‰§è¡Œ `docker-compose down -v` æ—¶ï¼š

```
1. åœæ­¢æ‰€æœ‰å®¹å™¨
   â†“
2. åˆ é™¤æ‰€æœ‰å®¹å™¨
   â†“
3. åˆ é™¤æ‰€æœ‰å‘½åå· (-v å‚æ•°)
   â”œâ”€ huangpu_postgres  â† PostgreSQL æ•°æ® âŒ
   â”œâ”€ huangpu_minio     â† MinIO æ–‡ä»¶ âŒ
   â”œâ”€ huangpu_nats      â† NATS æ•°æ® âŒ
   â””â”€ ... (å…¶ä»–å·)
   â†“
4. é‡æ–°å¯åŠ¨æ—¶ï¼Œæ•°æ®å·è¢«é‡æ–°åˆ›å»ºï¼ˆç©ºçš„ï¼‰
   â†“
5. ç³»ç»Ÿè‡ªåŠ¨åˆå§‹åŒ–é¢„ç½®æ•°æ®
   â”œâ”€ é‡‡é›†å™¨å®šä¹‰ âœ…
   â”œâ”€ æ§åˆ¶å™¨å®šä¹‰ âœ…
   â””â”€ äº‘åŒºåŸŸé…ç½® âœ…
   â†“
6. ä½†æ‰‹åŠ¨ä¸Šä¼ çš„æ•°æ®ä¸ä¼šæ¢å¤
   â”œâ”€ PackageVersion âŒ
   â”œâ”€ Node âŒ
   â””â”€ å®‰è£…è®°å½• âŒ
```

### 2.3 ä¸ºä»€ä¹ˆæœ‰äº›æ•°æ®è¿˜åœ¨ï¼Ÿ

**ç³»ç»Ÿé¢„ç½®æ•°æ®è¿˜åœ¨çš„åŸå› **ï¼š

è¿™äº›æ•°æ®æ˜¯é€šè¿‡ Django çš„åˆå§‹åŒ–å‘½ä»¤ï¼ˆmanagement commandsï¼‰è‡ªåŠ¨åˆ›å»ºçš„ï¼Œåœ¨å®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š

```python
# server/config/settings.py
INSTALLED_APPS = [
    'apps.node_mgmt',  # ä¼šæ‰§è¡Œ node_init å‘½ä»¤
    'apps.monitor',    # ä¼šæ‰§è¡Œ plugin_init å‘½ä»¤
    # ...
]
```

æœåŠ¡å¯åŠ¨æµç¨‹ï¼š
1. å®¹å™¨å¯åŠ¨
2. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆmigrateï¼‰
3. æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤ï¼ˆå¦‚ `node_init`ï¼‰â† è¿™é‡Œé‡å»ºäº†ç³»ç»Ÿé¢„ç½®æ•°æ®
4. å¯åŠ¨ Web æœåŠ¡

**æ‰‹åŠ¨ä¸Šä¼ çš„æ•°æ®ä¸¢å¤±çš„åŸå› **ï¼š

è¿™äº›æ•°æ®æ˜¯ç”¨æˆ·æ“ä½œäº§ç”Ÿçš„ï¼Œä¸åœ¨è‡ªåŠ¨åˆå§‹åŒ–èŒƒå›´å†…ï¼š
- æ¢é’ˆåŒ…ä¸Šä¼ ï¼ˆé€šè¿‡ API æˆ–è„šæœ¬ï¼‰
- èŠ‚ç‚¹å®‰è£…ï¼ˆé€šè¿‡ç•Œé¢æ“ä½œï¼‰
- é…ç½®ä¿®æ”¹ï¼ˆç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼‰

---

## ä¸‰ã€å½±å“è¯„ä¼°

### 3.1 æ•°æ®ä¸¢å¤±èŒƒå›´

| æ•°æ®ç±»å‹ | ä¸¢å¤±çŠ¶æ€ | å½±å“ | æ¢å¤æ–¹å¼ |
|---------|---------|------|---------|
| æ¢é’ˆåŒ…ç‰ˆæœ¬ | âŒ å®Œå…¨ä¸¢å¤± | æ— æ³•å®‰è£…æ¢é’ˆ | é‡æ–°ä¸Šä¼  |
| å·²å®‰è£…èŠ‚ç‚¹ | âŒ å®Œå…¨ä¸¢å¤± | èŠ‚ç‚¹åˆ—è¡¨ä¸ºç©º | é‡æ–°å®‰è£… |
| å®‰è£…å†å² | âŒ å®Œå…¨ä¸¢å¤± | æ— æ³•è¿½æº¯ | æ— æ³•æ¢å¤ |
| é‡‡é›†å™¨é…ç½® | âŒ å®Œå…¨ä¸¢å¤± | é…ç½®é‡ç½® | é‡æ–°é…ç½® |
| ç›‘æ§æ•°æ® | âŒ å®Œå…¨ä¸¢å¤± | å†å²æ•°æ®æ¶ˆå¤± | æ— æ³•æ¢å¤ |
| ç³»ç»Ÿé…ç½® | âŒ éƒ¨åˆ†ä¸¢å¤± | éœ€é‡æ–°é…ç½® | é‡æ–°é…ç½® |
| ç”¨æˆ·æ•°æ® | âŒ å®Œå…¨ä¸¢å¤± | è´¦å·æ¶ˆå¤± | é‡æ–°åˆ›å»º |

### 3.2 ä¸šåŠ¡å½±å“

1. **ç›‘æ§ä¸­æ–­** - æ‰€æœ‰å·²å®‰è£…çš„æ¢é’ˆå¤±è”
2. **æ•°æ®æ–­å±‚** - å†å²ç›‘æ§æ•°æ®å…¨éƒ¨ä¸¢å¤±
3. **é‡å¤å·¥ä½œ** - éœ€è¦é‡æ–°é…ç½®å’Œå®‰è£…
4. **ç”¨æˆ·ä½“éªŒ** - æ‰€æœ‰è‡ªå®šä¹‰é…ç½®ä¸¢å¤±

---

## å››ã€è§£å†³æ–¹æ¡ˆ

### 4.1 å¿«é€Ÿæ¢å¤æ­¥éª¤

#### æ­¥éª¤ 1: é‡æ–°ä¸Šä¼ æ¢é’ˆåŒ…

```bash
cd /home/soft/bk-lite/deploy-huangpu/

# 1. åˆå§‹åŒ–æ§åˆ¶å™¨åŒ…
./init-probe-packages.sh --auto

# 2. åˆå§‹åŒ–é‡‡é›†å™¨åŒ…
./init-collector-packages.sh
```

#### æ­¥éª¤ 2: éªŒè¯æ¢å¤ç»“æœ

```bash
# æ£€æŸ¥åŒ…ç‰ˆæœ¬è®°å½•
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT COUNT(*) as total, type FROM node_mgmt_packageversion GROUP BY type;"

# é¢„æœŸè¾“å‡ºï¼š
#  total |    type
# -------+------------
#      1 | controller
#      7 | collector
```

#### æ­¥éª¤ 3: é‡æ–°é…ç½®ç³»ç»Ÿï¼ˆå¦‚éœ€è¦ï¼‰

1. **é‡ç½®ç®¡ç†å‘˜å¯†ç **ï¼ˆå¦‚æœä¸¢å¤±ï¼‰ï¼š
   ```bash
   docker exec bklite-server-prod bash -c \
     "cd /apps && source .venv/bin/activate && \
      python manage.py createsuperuser"
   ```

2. **é‡æ–°é…ç½®äº‘åŒºåŸŸ**ï¼ˆå¦‚éœ€è¦ï¼‰
3. **é‡æ–°å®‰è£…æ¢é’ˆåˆ°ç›®æ ‡èŠ‚ç‚¹**
4. **é‡æ–°é…ç½®é‡‡é›†å™¨**

### 4.2 å®Œæ•´æ¢å¤è„šæœ¬

ä¸ºæ–¹ä¾¿æ¢å¤ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸€é”®æ¢å¤è„šæœ¬ï¼š

```bash
#!/bin/bash
# restore-after-down-v.sh

echo "æ£€æµ‹åˆ°æ•°æ®å¯èƒ½ä¸¢å¤±ï¼Œå¼€å§‹æ¢å¤..."

# 1. æ¢å¤æ¢é’ˆåŒ…
cd /home/soft/bk-lite/deploy-huangpu/
./init-probe-packages.sh --auto
./init-collector-packages.sh

# 2. éªŒè¯
echo "éªŒè¯æ¢å¤ç»“æœï¼š"
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT type, COUNT(*) FROM node_mgmt_packageversion GROUP BY type;"

echo "æ¢å¤å®Œæˆï¼è¯·æ‰‹åŠ¨é‡æ–°å®‰è£…æ¢é’ˆåˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚"
```

---

## äº”ã€é¢„é˜²æªæ–½

### 5.1 æ­£ç¡®çš„è¿ç»´æ“ä½œè§„èŒƒ

#### æ—¥å¸¸é‡å¯æ“ä½œ

```bash
# âœ… æ¨èï¼šåªé‡å¯å®¹å™¨
docker-compose restart

# âœ… å¯ä»¥ï¼šé‡æ–°åˆ›å»ºå®¹å™¨ä½†ä¿ç•™æ•°æ®
docker-compose down
docker-compose up -d

# âš ï¸ è°¨æ…ï¼šåªåœ¨éœ€è¦æ—¶ä½¿ç”¨
docker-compose stop
docker-compose start
```

#### éœ€è¦æ¸…ç†æ•°æ®æ—¶

```bash
# âš ï¸ å±é™©æ“ä½œï¼šåˆ é™¤æ‰€æœ‰æ•°æ®
# ä»…åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨ï¼š
# 1. æµ‹è¯•ç¯å¢ƒé‡ç½®
# 2. ç¡®è®¤ä¸éœ€è¦ä»»ä½•æ•°æ®
# 3. å·²åšå¥½æ•°æ®å¤‡ä»½

# åˆ é™¤å‰æç¤º
echo "è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼"
read -p "ç¡®è®¤ç»§ç»­ï¼Ÿ(yes/no) " confirm

if [ "$confirm" = "yes" ]; then
    docker-compose down -v
else
    echo "å·²å–æ¶ˆ"
fi
```

### 5.2 æ•°æ®å¤‡ä»½ç­–ç•¥

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup-bklite-data.sh

BACKUP_DIR="/backup/bklite/$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# 1. å¤‡ä»½æ•°æ®åº“
docker exec bklite-postgres-prod pg_dump -U postgres bklite > \
  "$BACKUP_DIR/database.sql"

# 2. å¤‡ä»½ MinIO æ•°æ®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
# docker exec bklite-minio-prod tar czf - /data > \
#   "$BACKUP_DIR/minio-data.tar.gz"

# 3. å¤‡ä»½é…ç½®æ–‡ä»¶
cp -r /home/soft/bk-lite/deploy-huangpu/conf "$BACKUP_DIR/"
cp /home/soft/bk-lite/deploy-huangpu/.secrets "$BACKUP_DIR/"

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

#### å®šæ—¶å¤‡ä»½ï¼ˆCronï¼‰

```bash
# æ·»åŠ åˆ° crontab
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * /home/soft/bk-lite/deploy-huangpu/backup-bklite-data.sh
```

### 5.3 æŒä¹…åŒ–éªŒè¯æ¸…å•

åœ¨éƒ¨ç½²åæ£€æŸ¥æŒä¹…åŒ–é…ç½®ï¼š

```bash
# 1. æ£€æŸ¥æ•°æ®å·é…ç½®
docker-compose config | grep -A 5 "volumes:"

# 2. æ£€æŸ¥æ•°æ®å·æ˜¯å¦åˆ›å»º
docker volume ls | grep huangpu

# 3. æ£€æŸ¥æ•°æ®å·æŒ‚è½½
docker inspect bklite-postgres-prod | grep -A 10 "Mounts"

# 4. æµ‹è¯•é‡å¯åæ•°æ®ä¿ç•™
# 4.1 æ·»åŠ æµ‹è¯•æ•°æ®
# 4.2 æ‰§è¡Œ docker-compose restart
# 4.3 éªŒè¯æ•°æ®ä»ç„¶å­˜åœ¨
```

---

## å…­ã€æ”¹è¿›å»ºè®®

### 6.1 ç³»ç»Ÿå±‚é¢æ”¹è¿›

#### æ–¹æ¡ˆ 1: è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤

åœ¨ `deploy.sh` ä¸­æ·»åŠ æ•°æ®ä¸¢å¤±æ£€æµ‹ï¼š

```bash
# deploy.sh ä¸­æ·»åŠ 
check_and_restore_data() {
    echo "æ£€æŸ¥æ•°æ®å®Œæ•´æ€§..."

    # æ£€æŸ¥æ¢é’ˆåŒ…æ•°é‡
    pkg_count=$(docker exec bklite-postgres-prod env PGPASSWORD=bklite \
        psql -U postgres -d bklite -t -c \
        "SELECT COUNT(*) FROM node_mgmt_packageversion;" | tr -d ' ')

    if [ "$pkg_count" -eq 0 ]; then
        echo "æ£€æµ‹åˆ°æ¢é’ˆåŒ…æ•°æ®ä¸¢å¤±ï¼Œè‡ªåŠ¨æ¢å¤..."
        ./init-probe-packages.sh --auto
        ./init-collector-packages.sh
    else
        echo "æ•°æ®å®Œæ•´ï¼Œæ¢é’ˆåŒ…æ•°é‡: $pkg_count"
    fi
}

# åœ¨æœåŠ¡å¯åŠ¨åè°ƒç”¨
check_and_restore_data
```

#### æ–¹æ¡ˆ 2: å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–

ä¿®æ”¹ Server å®¹å™¨çš„å¯åŠ¨è„šæœ¬ï¼Œåœ¨æœåŠ¡å¯åŠ¨åè‡ªåŠ¨æ£€æŸ¥å¹¶åˆå§‹åŒ–æ¢é’ˆåŒ…ã€‚

### 6.2 è¿ç»´å±‚é¢æ”¹è¿›

#### å»ºç«‹æ“ä½œè§„èŒƒæ–‡æ¡£

1. **æ“ä½œæ‰‹å†Œ**
   - æ—¥å¸¸è¿ç»´å‘½ä»¤æ¸…å•
   - å±é™©æ“ä½œè­¦å‘Š
   - å›æ»šæ­¥éª¤

2. **åº”æ€¥é¢„æ¡ˆ**
   - æ•°æ®ä¸¢å¤±å¿«é€Ÿæ¢å¤æµç¨‹
   - æœåŠ¡æ•…éšœå¤„ç†æµç¨‹
   - è”ç³»äººå’Œå‡çº§æœºåˆ¶

3. **å˜æ›´ç®¡ç†**
   - å˜æ›´å‰å¤‡ä»½
   - å˜æ›´å®¡æ‰¹æµç¨‹
   - å˜æ›´å›æ»šè®¡åˆ’

#### ç›‘æ§å’Œå‘Šè­¦

è®¾ç½®æ•°æ®å®Œæ•´æ€§ç›‘æ§ï¼š
```bash
# ç›‘æ§è„šæœ¬ï¼šcheck-data-integrity.sh
#!/bin/bash

pkg_count=$(docker exec bklite-postgres-prod env PGPASSWORD=bklite \
    psql -U postgres -d bklite -t -c \
    "SELECT COUNT(*) FROM node_mgmt_packageversion;" | tr -d ' ')

if [ "$pkg_count" -eq 0 ]; then
    echo "å‘Šè­¦ï¼šæ¢é’ˆåŒ…æ•°æ®ä¸ºç©ºï¼"
    # å‘é€å‘Šè­¦é€šçŸ¥
fi
```

---

## ä¸ƒã€ç»éªŒæ•™è®­

### 7.1 å…³é”®è¦ç‚¹

1. âš ï¸ **æ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `docker-compose down -v`**
2. âœ… **ä½¿ç”¨ `docker-compose restart` è¿›è¡Œæ—¥å¸¸é‡å¯**
3. âœ… **ä»»ä½•é‡å¤§æ“ä½œå‰éƒ½è¦å¤‡ä»½æ•°æ®**
4. âœ… **å»ºç«‹æ•°æ®æ¢å¤é¢„æ¡ˆå’Œè„šæœ¬**
5. âœ… **å®šæœŸæµ‹è¯•å¤‡ä»½å’Œæ¢å¤æµç¨‹**

### 7.2 Docker Compose å‘½ä»¤å®‰å…¨ç­‰çº§

| å‘½ä»¤ | å®‰å…¨ç­‰çº§ | æ•°æ®å½±å“ | ä½¿ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| `docker-compose restart` | ğŸŸ¢ å®‰å…¨ | æ— å½±å“ | æ—¥å¸¸é‡å¯ |
| `docker-compose stop/start` | ğŸŸ¢ å®‰å…¨ | æ— å½±å“ | ä¸´æ—¶åœæ­¢ |
| `docker-compose down && up -d` | ğŸŸ¡ æ³¨æ„ | æ— å½±å“ | æ›´æ–°é…ç½® |
| `docker-compose down -v` | ğŸ”´ å±é™© | **åˆ é™¤æ‰€æœ‰æ•°æ®** | ä»…æµ‹è¯•ç¯å¢ƒ |
| `docker volume rm` | ğŸ”´ å±é™© | **åˆ é™¤æŒ‡å®šæ•°æ®** | è°¨æ…æ“ä½œ |

---

## å…«ã€å¿«é€Ÿå‚è€ƒ

### 8.1 å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ•°æ®å·
docker volume ls

# æ£€æŸ¥æ¢é’ˆåŒ…æ•°é‡
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT COUNT(*) FROM node_mgmt_packageversion;"

# é‡æ–°åˆå§‹åŒ–æ¢é’ˆåŒ…
cd /home/soft/bk-lite/deploy-huangpu/
./init-probe-packages.sh --auto
./init-collector-packages.sh

# å¤‡ä»½æ•°æ®åº“
docker exec bklite-postgres-prod pg_dump -U postgres bklite > backup.sql

# æ¢å¤æ•°æ®åº“
docker exec -i bklite-postgres-prod psql -U postgres bklite < backup.sql
```

### 8.2 æ•…éšœæ’æŸ¥æµç¨‹

```
1. å‘ç°é—®é¢˜
   â†“
2. æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸¢å¤±
   SELECT COUNT(*) FROM node_mgmt_packageversion;
   â†“
3. ç¡®è®¤æ˜¯å¦æ‰§è¡Œè¿‡ docker-compose down -v
   â†“
4. è¿è¡Œæ¢å¤è„šæœ¬
   ./init-probe-packages.sh --auto
   ./init-collector-packages.sh
   â†“
5. éªŒè¯æ¢å¤ç»“æœ
   â†“
6. é‡æ–°é…ç½®å’Œå®‰è£…æ¢é’ˆ
```

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [æ¢é’ˆåŒ…åˆå§‹åŒ–é…ç½®æŒ‡å—](./æ¢é’ˆåŒ…åˆå§‹åŒ–é…ç½®æŒ‡å—.md)
- [å·²ä¸Šä¼ æ’ä»¶åŠŸèƒ½è¯´æ˜](./å·²ä¸Šä¼ æ’ä»¶åŠŸèƒ½è¯´æ˜.md)
- [å†…ç½‘ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ](./å†…ç½‘ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ.md)

---

## åã€æ€»ç»“

è¿™æ¬¡æ•°æ®ä¸¢å¤±äº‹ä»¶çš„æ ¹æœ¬åŸå› æ˜¯è¯¯ç”¨äº† `docker-compose down -v` å‘½ä»¤ã€‚è¯¥å‘½ä»¤ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®å·ï¼Œå¯¼è‡´åŒ…æ‹¬æ¢é’ˆåŒ…ã€èŠ‚ç‚¹è®°å½•åœ¨å†…çš„æ‰€æœ‰æ‰‹åŠ¨æ•°æ®ä¸¢å¤±ã€‚

**å…³é”®æ•™è®­**ï¼š
1. ç”Ÿäº§ç¯å¢ƒç¦ç”¨ `-v` å‚æ•°
2. å»ºç«‹å®Œå–„çš„å¤‡ä»½æœºåˆ¶
3. åˆ¶å®šæ˜ç¡®çš„æ“ä½œè§„èŒƒ
4. å‡†å¤‡æ•°æ®æ¢å¤é¢„æ¡ˆ

**é¢„é˜²æªæ–½**ï¼š
1. ä½¿ç”¨æ­£ç¡®çš„é‡å¯å‘½ä»¤
2. å®šæœŸè‡ªåŠ¨å¤‡ä»½æ•°æ®
3. å»ºç«‹æ•°æ®å®Œæ•´æ€§ç›‘æ§
4. ç¼–å†™è‡ªåŠ¨æ¢å¤è„šæœ¬

é€šè¿‡è¿™äº›æªæ–½ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œå¹¶åœ¨é—®é¢˜å‘ç”Ÿæ—¶å¿«é€Ÿæ¢å¤ã€‚

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šè¿ç»´å›¢é˜Ÿ
**æœ€åæ›´æ–°**ï¼š2025-10-21
**ç‰ˆæœ¬**ï¼š1.0.0
