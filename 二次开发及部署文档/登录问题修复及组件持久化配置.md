# 登录问题修复及组件持久化配置

**修复日期**: 2025-10-19
**修复人员**: Claude Code

## 问题描述

在首次部署BKLite开发环境时，遇到以下问题：

1. **登录页面无domain可选**: 前端登录页面的domain下拉框为空，无法选择domain
2. **登录失败报系统错误**: 使用admin/password登录后提示"System error occurred"
3. **MLflow容器持续重启**: 缺少psycopg2依赖，无法连接PostgreSQL
4. **组件持久化配置不完善**: 部分组件缺少数据持久化配置

## 根本原因分析

### 1. 登录问题根因

经过调查发现登录失败的根本原因是：

- **数据库未初始化**: `base_user`表中没有任何用户数据
- **NATS监听器未启动**: 后端使用NATS进行RPC通信，domain列表API(`get_login_module_domain_list`)需要通过NATS调用，但NATS监听器服务未运行

### 2. MLflow问题根因

官方MLflow镜像(`ghcr.io/mlflow/mlflow:latest`)缺少PostgreSQL客户端库`psycopg2`，导致无法连接PostgreSQL后端存储。

### 3. 持久化问题

- NATS服务定义了volume但未在启动命令中指定存储目录
- MLflow服务完全没有配置数据持久化

## 修复方案

### 1. 修复MLflow容器

#### 创建自定义Dockerfile

**文件**: `deploy/docker/mlflow/Dockerfile`

```dockerfile
FROM ghcr.io/mlflow/mlflow:latest

# 安装PostgreSQL客户端库
RUN pip install --no-cache-dir psycopg2-binary

# 使用原镜像的入口点
ENTRYPOINT ["mlflow"]
```

#### 修改docker-compose配置

**文件**: `docker-compose.dev.yml`

```yaml
mlflow:
  build:
    context: ./deploy/docker/mlflow
    dockerfile: Dockerfile
  image: bklite-mlflow:dev
  container_name: bklite-mlflow-dev
  command:
    - server  # 移除重复的mlflow，因为ENTRYPOINT已设置
    - --host
    - 0.0.0.0
    - --port
    - "5000"
    - --backend-store-uri
    - postgresql://postgres:bklite_dev_pass@postgres:5432/mlflow
    - --artifacts-destination
    - s3://mlflow-artifacts/
    - --serve-artifacts
  # ... 其他配置
```

#### 创建MLflow数据库

```bash
docker exec bklite-postgres-dev psql -U postgres -c "CREATE DATABASE mlflow;"
```

### 2. 完善组件持久化配置

#### 添加NATS持久化

修改NATS服务启动命令，添加存储目录参数：

```yaml
nats:
  image: nats:latest
  container_name: bklite-nats-dev
  command: ["-js", "-m", "8222", "-sd", "/data"]  # 添加 -sd /data
  volumes:
    - nats_dev:/data
```

#### 添加MLflow持久化

1. 添加volume定义：

```yaml
volumes:
  # ... 其他volumes
  mlflow_dev:  # 新增
```

2. 在MLflow服务中挂载volume：

```yaml
mlflow:
  # ... 其他配置
  volumes:
    - mlflow_dev:/mlflow
```

### 3. 初始化数据库并启动服务

#### 初始化数据库

```bash
./dev.sh db init
```

这个命令会执行：
- 运行数据库迁移
- 初始化系统资源（应用、角色、权限等）
- 创建admin用户（用户名: admin, 密码: password）
- 初始化各种组件（模型、插件、节点、日志、机器人、频道、LLM等）

#### 启动NATS监听器

```bash
cd server
nohup /home/superfm/.local/bin/uv run python manage.py nats_listener > /tmp/nats_listener.log 2>&1 &
```

**注意**: 需要使用uv的完整路径，因为它不在系统PATH中。

## 验证修复

### 1. 检查服务状态

```bash
./dev.sh status
```

预期输出：
```
基础设施服务:
  - postgres: healthy
  - redis: healthy
  - minio: healthy
  - nats: running
  - mlflow: running
  - falkordb: healthy
  - victoria-metrics: running
  - victoria-logs: running

Server 状态:
  ● 运行中 (PID: xxx) - http://localhost:18001

Web 状态:
  ● 运行中 (PID: xxx) - http://localhost:3011
```

### 2. 测试domain列表API

```bash
curl -s http://localhost:18001/api/v1/core/api/get_domain_list/
```

预期响应：
```json
{"result": true, "data": ["domain.com"]}
```

### 3. 测试登录API

```bash
curl -s -X POST http://localhost:18001/api/v1/core/api/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password","domain":"domain.com"}'
```

预期响应：
```json
{
  "result": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "username": "admin",
    "display_name": "admin",
    "id": 1,
    "domain": "domain.com",
    "locale": "zh-Hans",
    "temporary_pwd": false,
    "enable_otp": false,
    "qrcode": true
  }
}
```

### 4. 测试Web登录界面

访问 http://localhost:3011/auth/signin

1. Domain下拉框应显示 "domain.com"
2. 输入用户名: `admin`
3. 输入密码: `password`
4. 点击登录，应成功进入系统

## 修改文件清单

1. **deploy/docker/mlflow/Dockerfile** - 新建
2. **docker-compose.dev.yml** - 修改
   - 修改mlflow服务配置（build、command、volumes）
   - 修改nats服务配置（command添加-sd参数）
   - 添加mlflow_dev volume定义

## 登录凭证

- **用户名**: admin
- **密码**: password
- **Domain**: domain.com

## 重要说明

### NATS监听器启动

NATS监听器是系统正常运行的关键组件，负责处理RPC通信。在开发环境中需要手动启动：

```bash
cd /home/soft/bk-lite/server
nohup /home/superfm/.local/bin/uv run python manage.py nats_listener > /tmp/nats_listener.log 2>&1 &
```

### 持久化数据位置

所有持久化数据通过Docker volumes管理：

- `postgres_dev` - PostgreSQL数据
- `redis_dev` - Redis数据
- `nats_dev` - NATS JetStream数据
- `minio_dev` - MinIO对象存储数据
- `mlflow_dev` - MLflow元数据
- `victoria_metrics_dev` - VictoriaMetrics时序数据
- `victoria_logs_dev` - VictoriaLogs日志数据
- `falkordb_dev` - FalkorDB图数据库数据

查看volumes：
```bash
docker volume ls | grep bk-lite
```

## 后续优化建议

1. **自动启动NATS监听器**: 建议将NATS监听器集成到`./dev.sh start server`脚本中，实现自动启动
2. **健康检查优化**: 优化victoria-metrics、victoria-logs和nats的健康检查配置
3. **MLflow数据库自动创建**: 在初始化脚本中添加MLflow数据库的自动创建

## 故障排查

### 如果登录仍然失败

1. 检查NATS监听器是否运行：
   ```bash
   ps aux | grep "nats_listener" | grep -v grep
   ```

2. 检查NATS监听器日志：
   ```bash
   tail -f /tmp/nats_listener.log
   ```

3. 检查Server日志：
   ```bash
   ./dev.sh logs server
   ```

### 如果Domain列表为空

1. 确认NATS监听器正在运行
2. 检查NATS容器状态：
   ```bash
   docker logs bklite-nats-dev
   ```

3. 测试NATS连接：
   ```bash
   docker exec bklite-nats-dev wget -qO- http://localhost:8222/healthz
   ```
