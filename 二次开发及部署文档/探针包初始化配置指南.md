# BlueKing Lite 探针包初始化配置指南

## 文档信息
- **创建日期**: 2025-10-21
- **版本**: 1.0.0
- **适用环境**: 生产环境、离线环境

---

## 一、问题背景

### 1.1 问题现象
部署 BlueKing Lite 后，在前端界面的"节点管理 -> 探针管理 -> 控制器"页面中，探针包列表为空，无法进行探针推送和安装。

### 1.2 根本原因
系统初始化时未上传探针包文件到 NATS Object Store，导致：
- 数据库 `node_mgmt_packageversion` 表为空
- NATS Object Store 中没有探针包文件
- 前端无法获取可用的探针版本列表

---

## 二、探针包存储机制

### 2.1 存储架构
BlueKing Lite 使用 **NATS JetStream Object Store** 存储探针包文件，而不是传统的 MinIO。

```
探针包上传流程:
用户上传 → Django API → NATS JetStream Object Store
                    ↓
              PostgreSQL (元数据)
```

### 2.2 数据库模型

**PackageVersion 模型** (表名: `node_mgmt_packageversion`)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| type | String | 包类型 (controller/collector) |
| os | String | 操作系统 (linux/windows) |
| object | String | 包对象名称 (Controller/采集器名) |
| version | String | 版本号 (如 1.0.0) |
| name | String | 文件名 (如 fusion-collectors.zip) |
| description | Text | 描述信息 |
| created_by | String | 创建者 |
| created_at | DateTime | 创建时间 |

**唯一约束**: `(os, object, version)`

### 2.3 文件存储路径规则

```
NATS Object Store 路径格式:
{os}/{object}/{version}/{name}

示例:
linux/Controller/1.0.0/fusion-collectors-linux-amd64.zip
```

---

## 三、探针包类型说明

BlueKing Lite 系统中有两类探针包：

### 3.1 控制器包 (Controller Package)

- **包类型**: `type=controller`, `object=Controller`
- **文件名**: `fusion-collectors-linux-amd64.zip`
- **内容**: 包含所有探针组件的二进制文件
  - `collector-sidecar`: 探针管理服务
  - `bin/telegraf`: 指标采集器
  - `bin/vector`: 日志采集器
  - `bin/nats-executor`: NATS 执行器
  - 以及其他 Beat 系列采集器

### 3.2 采集器包 (Collector Package)

- **包类型**: `type=collector`, `object=采集器名称`
- **示例**:
  - Telegraf: `type=collector`, `object=Telegraf`
  - Vector: `type=collector`, `object=Vector`
  - NATS-Executor: `type=collector`, `object=NATS-Executor`
- **说明**:
  - 虽然采集器的二进制文件包含在 Controller 包中
  - 但前端需要为每个采集器单独显示版本信息
  - 因此需要为主要采集器创建独立的包记录

---

## 四、解决方案

### 4.1 方案一：自动初始化（推荐）

#### 步骤 1: 准备探针包文件

将探针包文件放置到 `deploy-huangpu/` 目录下：

```bash
cd /home/soft/bk-lite/deploy-huangpu/
# 确认文件存在
ls -lh fusion-collectors-linux-amd64.zip
```

#### 步骤 2: 运行初始化脚本

```bash
cd /home/soft/bk-lite/deploy-huangpu/

# 初始化控制器包
./init-probe-packages.sh --auto

# 初始化采集器包（必须在控制器包之后执行）
./init-collector-packages.sh
```

#### 预期输出

**控制器包初始化**:
```
========================================
BlueKing Lite 探针包初始化脚本
========================================

[检查环境]
✓ 环境检查通过

[自动初始化模式]

✓ 找到探针包: fusion-collectors-linux-amd64.zip

[上传探针包]
  文件名: fusion-collectors-linux-amd64.zip
  操作系统: linux
  对象类型: Controller
  版本号: 1.0.0
  包类型: controller

[1/3] 复制文件到容器...
[2/3] 检查是否已存在相同版本...
[3/3] 上传到 NATS Object Store...
INFO Connected to NATS and initialized object store: bklite
INFO Added entry linux/Controller/1.0.0/fusion-collectors-linux-amd64.zip
✓ 上传完成

[验证] 检查数据库记录...
 id |    type    |  os   |   object   | version |               name
----+------------+-------+------------+---------+-----------------------------------
  1 | controller | linux | Controller | 1.0.0   | fusion-collectors-linux-amd64.zip

========================================
已初始化 1 个探针包
========================================
```

**采集器包初始化**:
```
========================================
BlueKing Lite 采集器包初始化脚本
========================================

[环境检查]
✓ 环境检查通过

[检查] 检查 Controller 包是否已上传...
✓ Controller 包已存在

[初始化采集器包]

[创建] Telegraf (linux) 包记录...
  ✓ 创建成功
[创建] Vector (linux) 包记录...
  ✓ 创建成功
[创建] NATS-Executor (linux) 包记录...
  ✓ 创建成功
... (其他采集器)

[验证] 检查采集器包记录...
    type    |  os   |    object     | version |               name
------------+-------+---------------+---------+-----------------------------------
 collector  | linux | Telegraf      | 1.0.0   | fusion-collectors-linux-amd64.zip
 collector  | linux | Vector        | 1.0.0   | fusion-collectors-linux-amd64.zip
 collector  | linux | NATS-Executor | 1.0.0   | fusion-collectors-linux-amd64.zip
 ... (其他采集器)
 controller | linux | Controller    | 1.0.0   | fusion-collectors-linux-amd64.zip

========================================
采集器包初始化完成！
========================================
```

---

### 3.2 方案二：手动初始化

#### 使用 Django Management Command

```bash
# 1. 复制探针包到容器
docker cp /path/to/fusion-collectors.zip bklite-server-prod:/tmp/

# 2. 进入容器执行初始化
docker exec bklite-server-prod bash -c "cd /apps && source .venv/bin/activate && \
  python manage.py controller_package_init \
  --os linux \
  --object Controller \
  --pk_version 1.0.0 \
  --file_path /tmp/fusion-collectors.zip"

# 3. 清理临时文件
docker exec bklite-server-prod rm -f /tmp/fusion-collectors.zip
```

#### 参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| --os | 操作系统类型 | linux, windows |
| --object | 包对象名称 | Controller, Telegraf, Vector 等 |
| --pk_version | 包版本号 | 1.0.0, 2.0.0 等 |
| --file_path | 文件路径（容器内） | /tmp/xxx.zip |

---

### 3.3 方案三：通过 Web 界面上传

1. 访问 Web 界面：`http://<服务器IP>:8080`
2. 登录系统（默认账号: admin / admin）
3. 导航到：**节点管理 -> 探针管理 -> 控制器**
4. 点击 **"上传包"** 按钮
5. 填写表单：
   - 操作系统: `linux`
   - 包类型: `controller`
   - 包对象: `Controller`
   - 版本号: `1.0.0`
   - 上传文件: 选择探针包 zip 文件
6. 点击 **"提交"** 完成上传

---

## 四、验证探针包配置

### 4.1 验证数据库记录

```bash
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, type, os, object, version, name FROM node_mgmt_packageversion ORDER BY created_at DESC LIMIT 5;"
```

### 4.2 验证 Web 界面

1. 访问：**节点管理 -> 探针管理 -> 控制器**
2. 应该能看到探针包列表显示版本 `1.0.0`
3. 点击探针包卡片，可以查看详细信息

### 4.3 验证 API 接口

```bash
# 获取探针包列表
curl -s http://localhost:18001/api/v1/node_mgmt/api/package/ | jq

# 预期返回
{
  "count": 1,
  "results": [
    {
      "id": 1,
      "type": "controller",
      "os": "linux",
      "object": "Controller",
      "version": "1.0.0",
      "name": "fusion-collectors-linux-amd64.zip",
      "description": ""
    }
  ]
}
```

---

## 五、离线环境部署

### 5.1 准备文件清单

在**有网络的环境**中准备以下文件：

```
deploy-huangpu/
├── fusion-collectors-linux-amd64.zip   # 探针包文件 (必需)
├── init-probe-packages.sh               # 初始化脚本 (必需)
├── docker-compose.yml                   # Docker Compose 配置
├── .secrets                             # 密码配置文件
└── conf/                                # 配置文件目录
```

### 5.2 传输到离线环境

```bash
# 在有网络的机器上打包
cd /home/soft/bk-lite
tar czf bklite-deploy-huangpu.tar.gz deploy-huangpu/

# 通过 U 盘/移动硬盘传输到离线环境
```

### 5.3 离线环境初始化

```bash
# 1. 解压部署包
tar xzf bklite-deploy-huangpu.tar.gz
cd deploy-huangpu/

# 2. 启动服务（假设已启动）
# docker compose up -d

# 3. 初始化控制器包
./init-probe-packages.sh --auto

# 4. 初始化采集器包
./init-collector-packages.sh
```

---

## 六、探针包制作指南

### 6.1 从源码打包

如果需要自己制作探针包：

```bash
cd /home/soft/bk-lite/agents/fusion-collector

# 打包（会生成 tar.gz 格式，因为系统环境无 zip 命令）
./build-package.sh 1.0.0

# 输出文件
ls -lh build/fusion-collectors-1.0.0.tar.gz
```

### 6.2 探针包目录结构

```
fusion-collectors/
├── install.sh              # 安装脚本
├── uninstall.sh            # 卸载脚本
├── sidecar.yml             # Sidecar 配置文件
├── sidecar.service         # Systemd 服务文件
├── collector-sidecar       # Sidecar 可执行文件
├── bin/                    # 二进制文件目录
│   ├── telegraf            # Telegraf 二进制
│   ├── nats-executor       # NATS Executor 二进制
│   └── vector              # Vector 二进制
├── cache/                  # 缓存目录
├── generated/              # 生成文件目录
└── log/                    # 日志目录
```

### 6.3 支持的文件格式

- ✅ ZIP 格式: `fusion-collectors-*.zip`
- ✅ TAR.GZ 格式: `fusion-collectors-*.tar.gz`
- ✅ 其他压缩格式（需在容器内能解压）

---

## 七、常见问题

### Q1: 探针包列表仍然为空？

**检查步骤**:

1. 验证数据库记录：
   ```bash
   docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
     "SELECT COUNT(*) FROM node_mgmt_packageversion;"
   ```

2. 检查 NATS 连接：
   ```bash
   docker logs bklite-server-prod | grep "NATS"
   ```

3. 检查前端 API 请求：
   - 打开浏览器开发者工具
   - 查看 Network 标签
   - 找到 `/api/v1/node_mgmt/api/package/` 请求
   - 检查返回的数据

### Q2: 上传时提示"已存在相同版本"？

**解决方案**:

1. 更换版本号：
   ```bash
   ./init-probe-packages.sh --file fusion-collectors.zip --version 1.1.0
   ```

2. 或删除旧版本（需进入数据库）：
   ```bash
   docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
     "DELETE FROM node_mgmt_packageversion WHERE version='1.0.0';"
   ```

### Q3: 文件太大，上传超时？

**调整超时时间**:

```bash
# 在 docker-compose.yml 中为 server 服务添加环境变量
environment:
  - NATS_TIMEOUT=300  # 5 分钟
```

### Q4: 如何查看上传的日志？

```bash
# 实时查看 server 日志
docker logs -f bklite-server-prod

# 过滤相关日志
docker logs bklite-server-prod 2>&1 | grep -E "controller_package_init|jetstream"
```

---

## 八、初始化脚本使用说明

### 8.1 脚本参数

```bash
./init-probe-packages.sh [选项]
```

| 选项 | 说明 | 示例 |
|------|------|------|
| --auto | 自动初始化当前目录所有探针包 | `--auto` |
| --file | 指定单个探针包文件 | `--file xxx.zip` |
| --os | 操作系统（默认: linux） | `--os linux` |
| --object | 包对象名称（默认: Controller） | `--object Controller` |
| --version | 版本号（默认: 1.0.0） | `--version 2.0.0` |
| --type | 包类型（默认: controller） | `--type collector` |
| -h, --help | 显示帮助信息 | `-h` |

### 8.2 使用示例

#### 示例 1: 自动初始化（推荐）

```bash
cd /home/soft/bk-lite/deploy-huangpu/
./init-probe-packages.sh --auto
```

#### 示例 2: 指定文件和版本

```bash
./init-probe-packages.sh \
  --file fusion-collectors-linux-amd64.zip \
  --version 2.0.0
```

#### 示例 3: 上传采集器包

```bash
./init-probe-packages.sh \
  --file telegraf-collector.zip \
  --object Telegraf \
  --type collector \
  --version 1.0.0
```

---

## 九、探针安装流程

### 9.1 前置条件

1. ✅ 探针包已初始化到系统
2. ✅ 目标节点网络可达
3. ✅ 目标节点已配置 SSH 访问
4. ✅ 目标节点有 root 或 sudo 权限

### 9.2 推送安装流程

**通过 Web 界面**:

1. 访问：**节点管理 -> 云区域 -> 节点**
2. 点击 **"安装控制器"** 按钮
3. 选择安装方式：
   - **远程安装**: 通过 SSH 自动推送和安装
   - **手动安装**: 生成安装命令，手动在目标节点执行
4. 填写节点信息：
   - IP 地址
   - 节点名称
   - 组织（分组）
   - SSH 端口（默认 22）
   - SSH 用户名（默认 root）
   - SSH 密码
5. 选择控制器版本：`1.0.0`
6. 点击 **"开始安装"**

### 9.3 安装过程监控

安装过程会显示实时状态：

```
[等待中] → [运行中] → [成功/失败]
```

可以查看每个节点的安装日志和错误信息。

### 9.4 手动安装方式

如果使用手动安装方式，系统会生成安装命令：

```bash
# 下载探针包到目标节点
wget http://<server-ip>:8080/api/node_mgmt/download/<package_id> -O fusion-collectors.zip

# 解压
unzip fusion-collectors.zip -d /tmp/

# 执行安装
cd /tmp/fusion-collectors
sudo bash ./install.sh \
  http://<server-ip>:18001/api/v1/node_mgmt/open_api/node \
  <server_token> \
  <cloud_region> \
  <group> \
  <node_name> \
  <node_id>
```

---

## 十、附录

### 10.1 相关文件路径

| 文件 | 路径 |
|------|------|
| Django management command | `/home/soft/bk-lite/server/apps/node_mgmt/management/commands/controller_package_init.py` |
| 包上传工具 | `/home/soft/bk-lite/server/apps/node_mgmt/management/utils.py` |
| NATS 客户端 | `/home/soft/bk-lite/server/apps/rpc/jetstream.py` |
| 包模型定义 | `/home/soft/bk-lite/server/apps/node_mgmt/models/package.py` |
| 初始化脚本 | `/home/soft/bk-lite/deploy-huangpu/init-probe-packages.sh` |

### 10.2 相关 API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/v1/node_mgmt/api/package/ | GET | 获取探针包列表 |
| /api/v1/node_mgmt/api/package/ | POST | 上传探针包 |
| /api/v1/node_mgmt/api/package/{id}/ | DELETE | 删除探针包 |
| /api/v1/node_mgmt/api/package/download/{id}/ | GET | 下载探针包 |
| /api/v1/node_mgmt/api/installer/controller/install | POST | 安装控制器 |
| /api/v1/node_mgmt/api/installer/get_install_command | POST | 获取安装命令 |

### 10.3 数据库表结构

```sql
-- 查看表结构
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c "\d node_mgmt_packageversion"

-- 查询所有探针包
SELECT * FROM node_mgmt_packageversion ORDER BY created_at DESC;

-- 按类型统计
SELECT type, object, COUNT(*) FROM node_mgmt_packageversion GROUP BY type, object;
```

### 10.4 故障排查命令

```bash
# 1. 检查容器状态
docker ps -a | grep bklite

# 2. 检查 NATS 连接
docker logs bklite-server-prod 2>&1 | grep -i "nats.*connect"

# 3. 检查数据库连接
docker exec bklite-postgres-prod pg_isready -U postgres

# 4. 检查探针包记录
docker exec bklite-postgres-prod env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT * FROM node_mgmt_packageversion;"

# 5. 查看 server 日志
docker logs --tail 100 bklite-server-prod

# 6. 进入 server 容器调试
docker exec -it bklite-server-prod bash
```

---

## 联系与支持

如遇到问题，请：
1. 查看本文档的"常见问题"章节
2. 检查容器日志和数据库记录
3. 参考 `/home/soft/bk-lite/二次开发及部署文档/` 目录下的其他文档

---

**文档结束**
