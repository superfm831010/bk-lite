# 探针安装问题排查指南

## 问题描述

Linux服务器安装探针后，提示安装成功，但在节点管理界面看不到已安装探针的服务器。

## 问题原因分析

### 探针安装和节点注册流程

**1. 安装阶段**
```
用户提交安装请求
    ↓
后端生成 node_id 和 token
    ↓
通过SSH在远程服务器执行安装命令
    ↓
执行 /opt/fusion-collectors/install.sh
    ↓
启动 fusion-collectors 服务 (sidecar)
```

**2. 节点注册阶段**
```
Sidecar服务启动
    ↓
定期(30秒)向Server发送心跳: PUT {server_url}/api/v1/node_mgmt/open_api/node/sidecars/{node_id}
    ↓
Server接收到首次心跳后，在数据库中创建Node记录
    ↓
节点出现在节点管理列表中
```

**关键点**：安装脚本执行成功 ≠ 节点注册成功。只有Sidecar服务成功启动并向Server发送心跳后，节点才会出现在列表中。

### 可能的原因

1. **Sidecar服务未启动** - 安装脚本执行成功，但sidecar服务启动失败
2. **Server URL配置错误** - 数据库中配置的server_url不可达
3. **网络连接问题** - 目标服务器无法访问Server
4. **Token认证失败** - 生成的token与数据库记录不匹配
5. **云区域标签缺失** - 创建节点时需要云区域信息
6. **权限过滤** - 节点已创建，但当前用户无权查看

## 排查步骤

### 步骤1：检查Server URL配置

检查数据库中的SERVER_URL配置是否正确：

```bash
# 方法1：通过API检查
curl -s http://localhost:18001/api/v1/core/api/get_bk_settings/ | python3 -m json.tool

# 方法2：直接查询数据库
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT cloud_region_id, key, value FROM node_mgmt_sidecarenv WHERE key='SERVER_URL';"
```

**预期结果**：
- SERVER_URL应该是一个可访问的完整URL，如 `http://192.168.1.100:18001`
- 不应该是 `null` 或 `http://localhost:18001`（目标服务器无法访问localhost）

**解决方法**（如果配置错误）：
```bash
# 更新SERVER_URL配置
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "UPDATE node_mgmt_sidecarenv SET value='http://<实际IP>:18001' WHERE key='SERVER_URL' AND cloud_region_id=1;"
```

### 步骤2：检查节点是否已在数据库中

查询Node表，确认节点是否已经注册：

```bash
# 查询所有节点
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, name, ip, operating_system, cloud_region_id, updated_at FROM node_mgmt_node ORDER BY created_at DESC LIMIT 10;"

# 查询特定IP的节点
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, name, ip, operating_system, cloud_region_id, updated_at FROM node_mgmt_node WHERE ip='<目标服务器IP>';"
```

**情况分析**：
- **找到记录且updated_at在1分钟内** → 节点正常运行，可能是权限问题（跳到步骤6）
- **找到记录但updated_at超过1分钟** → Sidecar服务异常（跳到步骤4）
- **没有找到记录** → Sidecar从未成功连接（继续步骤3）

### 步骤3：检查安装任务执行结果

查看安装任务的详细日志：

```bash
# 查询最近的安装任务
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, status, created_at FROM node_mgmt_controllertask ORDER BY created_at DESC LIMIT 5;"

# 查看某个任务的节点执行结果（替换 <task_id>）
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT ip, os, status, result FROM node_mgmt_controllertasknode WHERE task_id=<task_id>;"
```

**分析result字段**：
```json
{
  "steps": [
    {"action": "credential_check", "status": "success"},
    {"action": "send", "status": "success"},  // 文件传输成功
    {"action": "run", "status": "success"}    // 安装命令执行成功
  ],
  "overall_status": "success"
}
```

如果所有步骤都是success，说明：
- 安装脚本执行成功
- 但Sidecar可能没有启动，或无法连接到Server

### 步骤4：登录目标服务器检查Sidecar服务状态

SSH登录到目标服务器：

```bash
# 检查sidecar进程是否运行
ps aux | grep fusion-collectors

# 检查安装目录
ls -la /opt/fusion-collectors/

# 查看sidecar服务状态（如果使用systemd）
systemctl status fusion-collectors
# 或
service fusion-collectors status

# 手动查看进程
pgrep -f fusion-collectors
```

**如果服务未运行**：

```bash
# 尝试启动服务
cd /opt/fusion-collectors
sudo ./start.sh

# 或使用systemd
sudo systemctl start fusion-collectors
```

### 步骤5：检查Sidecar日志

查看sidecar的运行日志：

```bash
# 查看日志文件（路径可能不同，根据实际情况调整）
tail -f /opt/fusion-collectors/logs/*.log

# 或查看systemd日志
journalctl -u fusion-collectors -f

# 检查是否有错误信息
grep -i error /opt/fusion-collectors/logs/*.log
grep -i "connection" /opt/fusion-collectors/logs/*.log
```

**常见错误及解决方法**：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `connection refused` | Server地址不可达 | 检查网络和SERVER_URL配置 |
| `401 Unauthorized` | Token认证失败 | 重新安装探针，生成新的token |
| `timeout` | 网络超时 | 检查防火墙规则和网络连接 |
| `no such host` | 域名解析失败 | 使用IP地址替代域名 |

### 步骤6：测试网络连接

从目标服务器测试到Server的连接：

```bash
# 测试端口是否可达
telnet <server_ip> 18001

# 或使用nc
nc -zv <server_ip> 18001

# 测试HTTP连接
curl -v http://<server_ip>:18001/api/v1/core/health/

# 检查防火墙规则
sudo iptables -L -n | grep 18001
```

### 步骤7：检查Token认证

查询数据库中的token记录：

```bash
# 查询最近生成的token
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT node_id, LEFT(token, 20) as token_prefix, created_at FROM node_mgmt_sidecarapitoken ORDER BY created_at DESC LIMIT 10;"

# 查询特定node_id的token
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT node_id, token, created_at FROM node_mgmt_sidecarapitoken WHERE node_id='<node_id>';"
```

### 步骤8：检查权限配置

如果节点在数据库中存在且updated_at是最近的，但前端看不到，可能是权限问题：

```bash
# 查询节点的组织关联
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT node_id, organization FROM node_mgmt_nodeorganization WHERE node_id IN (SELECT id FROM node_mgmt_node WHERE ip='<目标IP>');"
```

**解决方法**：
- 确认当前登录用户有访问该节点所属组织的权限
- 或在安装时正确配置组织参数

## 常见问题及解决方案

### 问题1：SERVER_URL配置为localhost或null

**现象**：数据库中SERVER_URL为 `http://localhost:18001` 或 `null`

**原因**：目标服务器无法访问localhost（localhost指向自己）

**解决**：
```bash
# 更新为实际可访问的IP地址
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "UPDATE node_mgmt_sidecarenv SET value='http://<实际服务器IP>:18001' WHERE key='SERVER_URL';"

# 重新安装探针
# 或在目标服务器上重启sidecar服务
```

### 问题2：Sidecar服务未自动启动

**现象**：安装成功，但ps命令找不到fusion-collectors进程

**原因**：install.sh脚本执行完成，但服务启动失败

**解决**：
```bash
# 手动启动服务
cd /opt/fusion-collectors
sudo ./start.sh

# 查看启动日志
tail -f /opt/fusion-collectors/logs/*.log

# 如果需要，配置开机自启动
sudo systemctl enable fusion-collectors
```

### 问题3：防火墙阻止连接

**现象**：目标服务器无法连接到Server的18001端口

**解决**：
```bash
# Server端开放端口
sudo firewall-cmd --zone=public --add-port=18001/tcp --permanent
sudo firewall-cmd --reload

# 或使用iptables
sudo iptables -I INPUT -p tcp --dport 18001 -j ACCEPT
sudo iptables-save

# 目标服务器端允许出站连接（通常默认允许）
```

### 问题4：权限不足导致看不到节点

**现象**：节点在数据库中存在，但前端列表看不到

**解决**：
1. 使用admin账户登录查看
2. 检查用户的组织权限配置
3. 确认安装时指定的组织ID是否正确

### 问题5：云区域配置错误

**现象**：节点创建失败，日志中提示云区域相关错误

**解决**：
```bash
# 查询可用的云区域
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, name FROM node_mgmt_cloudregion;"

# 安装时确保指定正确的云区域ID
# 通常默认云区域ID为1
```

## 完整的诊断脚本

将以下脚本保存为 `diagnose_probe.sh`，在Server上运行：

```bash
#!/bin/bash

# 探针安装诊断脚本
# 用法: ./diagnose_probe.sh <目标服务器IP>

TARGET_IP=$1

if [ -z "$TARGET_IP" ]; then
    echo "用法: $0 <目标服务器IP>"
    exit 1
fi

echo "========== 探针安装诊断 =========="
echo "目标服务器: $TARGET_IP"
echo

echo "1. 检查SERVER_URL配置..."
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT cloud_region_id, key, value FROM node_mgmt_sidecarenv WHERE key='SERVER_URL';"
echo

echo "2. 检查节点是否已注册..."
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT id, name, ip, operating_system, cloud_region_id, updated_at FROM node_mgmt_node WHERE ip='$TARGET_IP';"
echo

echo "3. 检查节点组织关联..."
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT no.node_id, no.organization FROM node_mgmt_nodeorganization no
   JOIN node_mgmt_node n ON no.node_id = n.id WHERE n.ip='$TARGET_IP';"
echo

echo "4. 检查最近的安装任务..."
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT t.id, t.status, t.created_at, tn.ip, tn.status as node_status
   FROM node_mgmt_controllertask t
   JOIN node_mgmt_controllertasknode tn ON t.id = tn.task_id
   WHERE tn.ip='$TARGET_IP'
   ORDER BY t.created_at DESC LIMIT 5;"
echo

echo "5. 检查Token记录..."
docker exec bklite-postgres-dev env PGPASSWORD=bklite psql -U postgres -d bklite -c \
  "SELECT sat.node_id, LEFT(sat.token, 30) as token_prefix, sat.created_at
   FROM node_mgmt_sidecarapitoken sat
   JOIN node_mgmt_node n ON sat.node_id = n.id
   WHERE n.ip='$TARGET_IP'
   ORDER BY sat.created_at DESC LIMIT 3;"
echo

echo "========== 诊断完成 =========="
echo
echo "请根据以上信息进行分析，或查看详细排查指南。"
```

使用方法：
```bash
chmod +x diagnose_probe.sh
./diagnose_probe.sh 192.168.1.100
```

## 预防措施

为避免此类问题，在安装探针前应确保：

1. **正确配置SERVER_URL**
   - 在系统设置中配置可从目标服务器访问的Server URL
   - 使用IP地址而非localhost或域名（如果DNS不可用）

2. **网络连通性**
   - 确保目标服务器可以访问Server的18001端口
   - 配置好防火墙规则

3. **云区域和组织**
   - 正确选择云区域
   - 指定正确的组织ID

4. **权限配置**
   - 确保当前用户有查看目标组织节点的权限

## 相关文件路径

### Server端
- 安装任务处理: `server/apps/node_mgmt/tasks/installer.py`
- 节点注册API: `server/apps/node_mgmt/services/sidecar.py` (update_node_client方法)
- 安装命令模板: `server/apps/node_mgmt/constants/controller.py`
- Node模型: `server/apps/node_mgmt/models/sidecar.py`

### 目标服务器端
- 安装目录: `/opt/fusion-collectors/`
- 启动脚本: `/opt/fusion-collectors/start.sh`
- 停止脚本: `/opt/fusion-collectors/stop.sh`
- 卸载脚本: `/opt/fusion-collectors/uninstall.sh`
- 日志目录: `/opt/fusion-collectors/logs/`

## 技术支持

如果按照以上步骤仍无法解决问题，请收集以下信息：

1. `diagnose_probe.sh` 脚本的输出
2. 目标服务器的Sidecar日志
3. 安装任务的result字段内容
4. Server端的日志（如有错误）

然后在项目Issues中提交问题报告。
