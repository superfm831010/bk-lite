# 修复内网部署初始化失败问题

## 问题描述

### 现象
在内网离线环境部署黄埔海关智能运维平台时，执行 `deploy.sh` 脚本后：
- server 容器创建成功，但一直处于不健康状态
- docker-compose 卡在 `Creating bklite-server-prod ... done` 后不动
- web 容器无法启动（依赖 server 健康检查）

### 日志错误
查看 server 容器日志发现大量 PyPI 访问失败错误：

```
× Failed to build `server @ file:///apps`
├─? Failed to fetch: `https://pypi.org/simple/setuptools/`
├─? Request failed after 3 retries
├─? dns error
╰─? failed to lookup address information: Temporary failure in name resolution
```

错误出现在多个初始化阶段：
- 系统管理资源初始化
- CMDB资源初始化
- 监控资源初始化
- 节点管理初始化
- 告警系统初始化
- 运营分析初始化

## 根本原因

### 问题分析

**server 容器启动脚本使用 `uv run python` 执行所有 Django 管理命令**

查看 `server/support-files/release/startup.sh`：

```bash
uv run python manage.py migrate || true
uv run python manage.py createcachetable django_cache
uv run python manage.py init_realm_resource || true
uv run python manage.py model_init || true
# ... 等等
```

### 问题根源

1. **`uv run` 的工作机制**：
   - `uv run` 在每次执行时会检查依赖环境
   - 尝试同步和验证 Python 包
   - 需要访问 PyPI (https://pypi.org) 获取包信息

2. **内网离线环境限制**：
   - 无法访问外网 PyPI 服务器
   - DNS 解析失败
   - 导致每个 `uv run` 命令都失败重试

3. **镜像构建问题**：
   - Dockerfile 中虽然执行了 `uv sync --all-groups` 和 `uv sync --all-extras`
   - 但 `uv run` 仍然会尝试联网验证依赖
   - 离线模式未正确配置

## 解决方案

### 方案选择

采用**永久修复方案**：修改启动脚本直接使用虚拟环境的 Python，避免 uv 的联网检查。

### 修改内容

#### 1. 修改 startup.sh

**文件位置**：`server/support-files/release/startup.sh`

**修改方式**：将所有 `uv run python` 替换为 `.venv/bin/python`

**修改前**：
```bash
uv run python manage.py migrate || true
uv run python manage.py createcachetable django_cache
uv run python manage.py init_realm_resource || true
```

**修改后**：
```bash
.venv/bin/python manage.py migrate || true
.venv/bin/python manage.py createcachetable django_cache
.venv/bin/python manage.py init_realm_resource || true
```

**影响范围**：共 16 处命令被修改

#### 2. 重新构建镜像

由于启动脚本已打包在镜像中，需要重新构建：

**构建命令**：
```bash
cd /home/soft/bk-lite/server
docker build -f support-files/release/Dockerfile -t bklite/server:huangpu-v1.0 .
```

**注意事项**：
- 必须在有网络的环境构建（需要下载 Python 依赖）
- 构建时间约 2-3 分钟
- 镜像大小约 2.4GB

#### 3. 导出镜像

**导出命令**：
```bash
cd /home/soft/bk-lite/deploy-huangpu
docker save bklite/server:huangpu-v1.0 -o images/server-huangpu.tar
```

## 部署到内网服务器

### 步骤 1：传输镜像文件

将导出的 `server-huangpu.tar` 文件传输到内网服务器：

```bash
# 在开发机器上
scp deploy-huangpu/images/server-huangpu.tar root@内网服务器IP:/path/to/deploy-huangpu/images/

# 或使用 U 盘等物理介质传输
```

### 步骤 2：导入镜像

在内网服务器上导入新镜像：

```bash
cd /path/to/deploy-huangpu
docker load -i images/server-huangpu.tar
```

**验证导入**：
```bash
docker images | grep bklite/server
# 应该看到：
# bklite/server  huangpu-v1.0  <IMAGE_ID>  <SIZE>
```

### 步骤 3：停止现有服务

```bash
cd /path/to/deploy-huangpu
docker-compose down -v
```

**警告**：`-v` 参数会删除所有数据卷，如果需要保留数据请去掉此参数。

### 步骤 4：清除初始化标记

```bash
rm .initialized
```

这样部署脚本会重新执行完整的初始化流程。

### 步骤 5：重新部署

```bash
sh deploy.sh
```

**预期结果**：
- 不再出现 PyPI 访问错误
- 初始化过程顺利完成（约 2-5 分钟）
- 所有服务健康检查通过
- 可以通过 http://服务器IP:8080 访问系统

## 验证步骤

### 1. 监控容器日志

在新终端执行：
```bash
docker-compose logs -f server
```

**正常日志应该显示**：
- 数据库迁移成功
- 系统管理资源初始化完成
- CMDB资源初始化完成
- 监控资源初始化完成
- 各模块初始化成功
- Supervisor 启动各服务进程

**不应该出现**：
- PyPI 访问错误
- DNS 解析失败
- 重复的 "Building server @ file:///apps" 错误

### 2. 检查容器状态

```bash
docker-compose ps
```

**预期输出**：
- server 容器状态：`Up` 且 `(healthy)`
- web 容器状态：`Up` 且 `(healthy)`
- 所有基础设施服务：`Up` 且 `(healthy)`

### 3. 访问系统

浏览器访问：`http://服务器IP:8080`

**预期结果**：
- 显示登录页面
- 可以使用 admin/password 登录
- 能够正常访问各功能模块

### 4. 检查初始化数据

登录后检查：
- 系统管理 → 用户管理：应该有 admin 用户
- CMDB → 模型管理：应该有预置模型
- 监控 → 采集插件：应该有内置插件
- 告警 → 规则管理：应该有内置规则

## 技术细节

### 为什么直接使用 .venv/bin/python 可以解决问题？

1. **依赖已打包**：
   - Dockerfile 中的 `uv sync` 步骤已将所有依赖安装到 `.venv` 目录
   - Python 虚拟环境是完整且独立的

2. **跳过联网检查**：
   - `.venv/bin/python` 直接使用虚拟环境中的 Python 解释器
   - 不经过 uv 的依赖管理逻辑
   - 避免了 PyPI 访问

3. **保持兼容性**：
   - 命令参数完全相同
   - Django 管理命令执行结果一致
   - 不影响功能

### 其他可选方案

如果此方案不生效，还可以尝试：

#### 方案 2：配置 uv 离线模式

在 `docker-compose.yml` 的 server 服务中添加环境变量：

```yaml
environment:
  - UV_NO_SYNC=1
  - UV_OFFLINE=1
```

#### 方案 3：配置内网 PyPI 镜像

搭建内网 PyPI 镜像服务器，配置 uv 使用内网镜像。

## 相关文件

- `server/support-files/release/startup.sh` - 容器启动脚本
- `server/support-files/release/Dockerfile` - Server 镜像构建文件
- `deploy-huangpu/docker-compose.yml` - 生产环境编排配置
- `deploy-huangpu/deploy.sh` - 部署脚本

## 问题总结

### 经验教训

1. **内网部署要考虑完全离线**：
   - 任何联网操作都可能导致失败
   - 需要提前规避所有外网依赖

2. **uv 工具的特性**：
   - `uv run` 不适合离线环境
   - 应该在构建时完成依赖安装，运行时直接使用

3. **容器健康检查的重要性**：
   - 帮助快速发现服务启动问题
   - 但超时时间需要合理设置（当前 300 次重试 = 50 分钟）

### 后续优化建议

1. **优化健康检查配置**：
   - 减少重试次数到 60 次（10 分钟）
   - 超时后明确报错，便于排查

2. **添加启动进度提示**：
   - 在 deploy.sh 中添加实时日志输出
   - 显示初始化进度

3. **文档完善**：
   - 在部署文档中明确说明离线部署要求
   - 提供故障排查指南

## 修订历史

- 2025-10-21：初始版本，解决内网部署 PyPI 访问问题
