# 第一阶段：使用 Go 1.23 编译
FROM golang:1.23-alpine AS builder

WORKDIR /build

# 复制 go.mod 和 go.sum
COPY go.mod ./
COPY go.sum ./

# 下载依赖
RUN go mod download

# 复制源代码
COPY . .

# 更新 go.mod（在 Go 1.23 环境中）
RUN go mod tidy

# 编译
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o nats-executor main.go

# 第二阶段：运行时镜像
FROM ubuntu:24.04

ENV NATS_INSTANCE_ID="default"
ENV NATS_URLS="nats://admin:password@nats:4222"

RUN apt-get update && \
    apt-get install -y sshpass supervisor && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 从构建阶段复制编译好的二进制文件
COPY --from=builder /build/nats-executor /opt/nats-executor
COPY ./support-files/startup.sh /opt/startup.sh
COPY ./support-files/service.conf /etc/supervisor/conf.d/service.conf

RUN chmod +x /opt/startup.sh
RUN chmod +x /opt/nats-executor

ENTRYPOINT ["/bin/bash", "/opt/startup.sh"]
